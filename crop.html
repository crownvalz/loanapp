<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Passport Photo Crop Tool</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
  <style>
    /* Fixed size for the modal */
    .modal-dialog {
      max-width: 800px; /* Set the maximum width of the modal */
      width: 100%; /* Make it responsive */
    }
    .modal-body {
      max-height: 500px; /* Set maximum height for the modal content */
      overflow-y: auto; /* Enable scrolling if content overflows */
    }
    #imageToCrop {
      max-width: 100%; /* Make the image responsive */
      max-height: 400px; /* Ensure the image doesn't exceed a certain height */
      display: none; /* Initially hidden */
    }
  </style>
</head>

<body>
  <div class="container d-flex flex-column align-items-center py-5">
    <!-- Button to Open Crop Modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cropModal">
      Upload & Crop Photo
    </button>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cropModalLabel">Crop the Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <input type="file" class="form-control" id="imageUpload" accept="image/*" required>
            <small class="form-text text-muted">Upload a clear photo for best results.</small>
            <div class="mt-3 d-flex justify-content-center">
              <img id="imageToCrop" src="" alt="To Crop">
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <button type="button" class="btn btn-secondary" onclick="applyCrop()" data-bs-dismiss="modal">Crop & Save</button>
            <button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Form for PDF generation and cropped image preview -->
    <div class="mt-5 text-center" id="previewContainer" style="display: none; width: 100%; max-width: 500px;">
      <h5>Cropped Image Preview</h5>
      <img id="croppedImagePreview" src="" alt="Cropped Preview" class="mb-3 img-fluid" style="max-width: 100%; border: 1px solid #ccc;">
      <button class="btn btn-secondary mb-3" onclick="recropImage()">Crop Again</button>

      <form id="photoForm" class="text-center">
        <div class="form-group">
          <label for="nameField">Name (Optional)</label>
          <input type="text" class="form-control text-center" id="nameField" placeholder="Enter a name for the PDF file">
        </div>
        <div class="form-group mt-3">
          <label for="photoCount">Number of Photos</label>
          <input type="number" class="form-control text-center" id="photoCount" value="1" min="1" max="20" required>
        </div>
        <button type="button" class="btn btn-primary mt-3 w-100" onclick="generatePDF()" id="generateBtn">Generate PDF</button>
      </form>
    </div>
  </div>

  <!-- JavaScript Files -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

  <script>
    let cropper;
    let croppedImageDataURL;
    const imageToCrop = document.getElementById("imageToCrop");
    const croppedImagePreview = document.getElementById("croppedImagePreview");
    const previewContainer = document.getElementById("previewContainer");

    // Handle image upload and initialize cropper
    document.getElementById("imageUpload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          initializeCropper(event.target.result); // Initialize with uploaded image
        };
        reader.readAsDataURL(file);
      }
    });

    function initializeCropper(imageSrc) {
      imageToCrop.src = imageSrc;
      imageToCrop.style.display = "block";
      if (cropper) cropper.destroy();
      cropper = new Cropper(imageToCrop, {
        aspectRatio: 4 / 5,
        scalable: true,
        zoomable: true,
        viewMode: 1,
      });
    }

    function applyCrop() {
      const croppedCanvas = cropper.getCroppedCanvas({ width: 200, height: 250 });
      croppedImageDataURL = croppedCanvas.toDataURL("image/jpeg");
      croppedImagePreview.src = croppedImageDataURL;
      previewContainer.style.display = "block";

      cropper.destroy();
    }

    function recropImage() {
      initializeCropper(croppedImageDataURL); // Reinitialize cropper with previously cropped image
      const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
      cropModal.show();
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'a4');
      const imgWidth = 35;
      const imgHeight = 45;
      const margin = 8;
      const docWidth = 210;
      const docHeight = 297;

      const photoCount = parseInt(document.getElementById("photoCount").value);
      let x = margin;
      let y = margin;

      for (let i = 0; i < photoCount; i++) {
        if (y + imgHeight + margin > docHeight) {
          alert("Reached maximum number of images for a single A4 page.");
          break;
        }
        if (x + imgWidth + margin > docWidth) {
          x = margin;
          y += imgHeight + margin;
        }
        doc.addImage(croppedImageDataURL, 'JPEG', x, y, imgWidth, imgHeight);
        x += imgWidth + margin;
      }

      doc.setFontSize(10);
      doc.text("Â© 2024 Lifeme. All Rights Reserved.", docWidth / 2, docHeight - 10, null, null, 'center');

      const fileName = document.getElementById("nameField").value || "passport_photos";
      doc.save(`${fileName}.pdf`);
    }
  </script>
</body>
</html>