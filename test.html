<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        #cropCanvas {
            border: 1px solid #dee2e6;
            cursor: crosshair;
        }
        .crop-area {
            border: 2px dashed #007bff;
            position: absolute;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="text-center">Passport Photo Editor</h1>
    <input type="file" id="upload" accept="image/*" class="form-control mb-3">
    <button id="removeBgBtn" class="btn btn-danger mb-3">Remove Background</button>
    
    <div class="text-center">
        <img id="preview" src="#" alt="Preview" class="img-fluid" style="display:none;">
    </div>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div style="position: relative;">
                        <canvas id="cropCanvas" class="w-100"></canvas>
                        <div id="cropArea" class="crop-area" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="cropBtn" class="btn btn-primary">Crop</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    let canvas = document.getElementById('cropCanvas');
    let context = canvas.getContext('2d');
    let img = new Image();
    let startX, startY, endX, endY, isCropping = false;

    // Handle image upload
    $('#upload').on('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                img.onload = function() {
                    $('#preview').attr('src', img.src).show();
                    $('#cropModal').modal('show');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                };
            };
            reader.readAsDataURL(file);
        }
    });

    // Remove background functionality
    $('#removeBgBtn').on('click', function() {
        const imageData = canvas.toDataURL('image/png'); // Get image data from canvas
        removeBackground(imageData); // Call the remove background function
    });

    function removeBackground(imageData) {
        $.ajax({
            url: 'https://api.remove.bg/v1.0/removebg',
            type: 'POST',
            headers: {
                'X-Api-Key': 'YOUR_API_KEY', // Replace with your API key
            },
            data: {
                image_file_b64: imageData.split(',')[1], // Extract base64 data
                size: 'auto',
            },
            success: function(data) {
                // Update the canvas with the background-removed image
                img.src = data.data.result_b64; // Update the image source
                img.onload = function() {
                    context.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0); // Draw the new image
                };
            },
            error: function(err) {
                console.error(err);
            }
        });
    }

    // Crop functionality
    $('#cropCanvas').on('mousedown', function(e) {
        startX = e.offsetX;
        startY = e.offsetY;
        isCropping = true;
        $('#cropArea').css({
            left: startX + 'px',
            top: startY + 'px',
            display: 'block'
        });
    });

    $('#cropCanvas').on('mousemove', function(e) {
        if (isCropping) {
            endX = e.offsetX;
            endY = e.offsetY;
            const width = endX - startX;
            const height = endY - startY;

            $('#cropArea').css({
                width: Math.abs(width) + 'px',
                height: Math.abs(height) + 'px',
                left: (width < 0 ? endX : startX) + 'px',
                top: (height < 0 ? endY : startY) + 'px'
            });
        }
    });

    $('#cropCanvas').on('mouseup', function() {
        isCropping = false;
    });

    $('#cropBtn').on('click', function() {
        const croppedWidth = Math.abs(endX - startX);
        const croppedHeight = Math.abs(endY - startY);
        const cropX = (croppedWidth < 0) ? endX : startX;
        const cropY = (croppedHeight < 0) ? endY : startY;

        // Get cropped image data
        let croppedImage = context.getImageData(cropX, cropY, croppedWidth, croppedHeight);
        canvas.width = croppedWidth;
        canvas.height = croppedHeight;
        context.putImageData(croppedImage, 0, 0); // Put cropped image data back to canvas
        $('#cropArea').hide(); // Hide crop area
        $('#cropModal').modal('hide'); // Close the modal
    });
});
</script>
</body>
</html>